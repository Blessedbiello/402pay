# x402 Protocol Implementation

Complete HTTP 402 Payment Required implementation for Solana blockchain.

## Overview

402pay provides full x402 protocol compliance, allowing you to create paid APIs, AI agent services, and premium content with micropayments on Solana.

**Key Features:**
- âœ… HTTP 402 Payment Required standard compliance
- âœ… Automatic Solana blockchain payment verification
- âœ… Client SDK for easy integration
- âœ… Express middleware for backend protection
- âœ… 5 working example endpoints
- âœ… Native SOL and SPL token support (SOL implemented, SPL coming soon)

## Quick Start

### 1. Install SDK

```bash
npm install @402pay/sdk @402pay/shared
```

### 2. Create Paid Endpoint (Server)

```typescript
import express from 'express';
import { x402Middleware } from '@402pay/facilitator/middleware/x402';

const app = express();

app.get(
  '/api/premium-data',
  x402Middleware({
    amount: '1000000', // 0.001 SOL (1M lamports)
    recipient: 'YOUR_WALLET_ADDRESS',
    description: 'Premium market data access',
    mimeType: 'application/json',
  }),
  (req, res) => {
    // Payment verified - serve content
    res.json({
      data: 'Premium content here',
      payment: req.x402Payment,
    });
  }
);

app.listen(3000);
```

### 3. Make Paid Request (Client)

```typescript
import { X402Client, Keypair } from '@402pay/sdk';

// Create client with wallet
const client = new X402Client({
  payer: Keypair.fromSecretKey(secretKey),
  rpcUrl: 'https://api.devnet.solana.com',
});

// Make paid request (automatically handles payment)
const result = await client.paidRequest('http://localhost:3000/api/premium-data');

console.log(result.data); // Your premium content
console.log(result.payment.signature); // Solana transaction signature
```

## How It Works

### Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                    â”‚  x402   â”‚                    â”‚ Solana  â”‚
â”‚   SDK   â”‚                    â”‚ Server  â”‚                    â”‚  Chain  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                              â”‚                              â”‚
     â”‚ 1. GET /api/premium          â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                              â”‚                              â”‚
     â”‚ 2. HTTP 402 + Requirements   â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
     â”‚                              â”‚                              â”‚
     â”‚ 3. Create SOL payment        â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                              â”‚
     â”‚ 4. Transaction confirmed     â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                              â”‚
     â”‚ 5. Retry with X-PAYMENT      â”‚                              â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
     â”‚                              â”‚                              â”‚
     â”‚                              â”‚ 6. Verify on-chain           â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                              â”‚                              â”‚
     â”‚                              â”‚ 7. Transaction verified      â”‚
     â”‚                              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚                              â”‚
     â”‚ 8. HTTP 200 + Content        â”‚                              â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚
```

### Step-by-Step

1. **Initial Request**: Client makes request without payment
2. **HTTP 402 Response**: Server returns payment requirements
3. **Payment Creation**: Client creates Solana transaction
4. **Payment Header**: Client encodes payment proof as base64 JSON
5. **Retry with Payment**: Client retries with `X-PAYMENT` header
6. **Verification**: Server verifies transaction on Solana blockchain
7. **Content Delivery**: Server returns content with `X-PAYMENT-RESPONSE` header

## Live Examples

Try these endpoints running on the 402pay facilitator:

### Example 1: Simple Paid Greeting

**Price**: 0.001 SOL

```bash
# Step 1: See payment requirements
curl http://localhost:3001/x402/paid-greeting

# Response: HTTP 402
{
  "x402Version": "0.1.0",
  "paymentRequirements": [{
    "scheme": "exact",
    "network": "solana-devnet",
    "maxAmountRequired": "1000000",
    "recipient": "YOUR_WALLET",
    "resource": "/x402/paid-greeting",
    "description": "Access to premium greeting service"
  }]
}
```

```typescript
// Step 2: Use SDK to pay and access
import { X402Client } from '@402pay/sdk';

const client = new X402Client({ payer: keypair });
const result = await client.paidRequest('http://localhost:3001/x402/paid-greeting');

console.log(result.data);
// {
//   message: "Hello from paid endpoint!",
//   greeting: "ðŸ‘‹ Welcome to x402 on Solana",
//   payment: { from: "...", amount: "1000000", signature: "..." }
// }
```

### Example 2: Premium Market Data

**Price**: 0.005 SOL

```typescript
const result = await client.paidRequest('http://localhost:3001/x402/paid-data');

console.log(result.data);
// {
//   data: {
//     symbol: "SOL/USD",
//     price: 142.35,
//     change24h: 5.67,
//     volume24h: 2450000000
//   },
//   meta: { paid: true, amount: "5000000", payer: "..." }
// }
```

### Example 3: AI Inference Service

**Price**: 0.01 SOL per request

```typescript
const result = await client.paidRequest('http://localhost:3001/x402/paid-inference', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ prompt: 'Explain blockchain in simple terms' }),
});

console.log(result.data);
// {
//   prompt: "Explain blockchain...",
//   completion: "AI generated response...",
//   model: "gpt-4-simulated",
//   tokens: { total: 150 },
//   payment: { signature: "...", from: "..." }
// }
```

### Example 4: AI Image Generation

**Price**: 0.02 SOL per image

```typescript
const result = await client.paidRequest('http://localhost:3001/x402/paid-image', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    prompt: 'A futuristic city on Mars',
    size: '1024x1024'
  }),
});

console.log(result.data.imageUrl);
```

### Example 5: Paid API Proxy

**Price**: 0.002 SOL per request

```typescript
// Access weather data
const weather = await client.paidRequest('http://localhost:3001/x402/paid-proxy/weather');

// Access stock prices
const stocks = await client.paidRequest('http://localhost:3001/x402/paid-proxy/stocks');

// Access crypto prices
const crypto = await client.paidRequest('http://localhost:3001/x402/paid-proxy/crypto');
```

## SDK Reference

### X402Client

Main client for interacting with x402 endpoints.

#### Constructor

```typescript
const client = new X402Client({
  payer: Keypair | Uint8Array,      // Wallet for payments
  rpcUrl?: string,                   // Solana RPC URL (defaults to devnet)
  network?: string,                  // Network ID (defaults to 'solana-devnet')
});
```

#### Methods

##### `paidRequest(url, options?)`

Make a paid request with automatic payment handling.

```typescript
const result = await client.paidRequest(
  'https://api.example.com/premium-data',
  {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' },
  }
);

// Returns:
// {
//   data: any,                    // Response data
//   payment: {
//     signature: string,          // Solana transaction signature
//     amount: string,             // Amount paid in lamports
//     from: string,               // Payer public key
//     to: string,                 // Recipient public key
//   },
//   response: PaymentResponse     // Server payment confirmation
// }
```

##### `getPaymentRequirements(url, options?)`

Get payment requirements without paying (useful for displaying price to user).

```typescript
const { requirements, priceInSOL, priceInLamports } =
  await client.getPaymentRequirements('https://api.example.com/premium-data');

console.log(`Price: ${priceInSOL} SOL`);
```

##### `checkBalance(requiredLamports)`

Check if wallet has sufficient balance.

```typescript
const { hasEnough, balance, required, shortfall } =
  await client.checkBalance('1000000');

if (!hasEnough) {
  console.log(`Need ${shortfall} more lamports`);
}
```

##### `getBalance()`

Get wallet balance in SOL.

```typescript
const balance = await client.getBalance();
console.log(`Balance: ${balance} SOL`);
```

##### `getPublicKey()`

Get wallet public key.

```typescript
const pubkey = client.getPublicKey();
console.log(pubkey.toBase58());
```

### Helper Functions

#### `createX402Client(secretKey, rpcUrl?)`

Create client from secret key array.

```typescript
import { createX402Client } from '@402pay/sdk';

const client = createX402Client(
  [1, 2, 3, ...], // Secret key array
  'https://api.devnet.solana.com'
);
```

#### `generateTestWallet()`

Generate a test wallet for development.

```typescript
import { generateTestWallet } from '@402pay/sdk';

const { keypair, publicKey, secretKey } = generateTestWallet();

console.log('Public Key:', publicKey);
console.log('Secret Key:', Array.from(secretKey));
```

## Middleware Reference

### x402Middleware(config)

Express middleware for protecting routes with x402 payments.

```typescript
import { x402Middleware } from '@402pay/facilitator/middleware/x402';

app.get('/api/resource',
  x402Middleware({
    amount: string,           // Required amount in lamports
    recipient: string,        // Your wallet address
    description: string,      // Resource description
    network?: string,         // Network (default: 'solana-devnet')
    assetAddress?: string,    // SPL token mint (omit for SOL)
    mimeType?: string,        // Resource MIME type
    timeout?: number,         // Payment timeout in ms
  }),
  (req, res) => {
    // req.x402Payment contains verified payment
    // req.x402Verified is true
    res.json({ data: 'Your content' });
  }
);
```

### Request Object Extensions

```typescript
interface X402Request extends Request {
  x402Payment?: PaymentPayload;    // Verified payment data
  x402Verified?: boolean;          // Payment verification status
}
```

## Protocol Specification

### HTTP 402 Payment Required Response

```json
{
  "x402Version": "0.1.0",
  "paymentRequirements": [
    {
      "scheme": "exact",
      "network": "solana-devnet",
      "maxAmountRequired": "1000000",
      "recipient": "WALLET_ADDRESS",
      "resource": "/api/resource",
      "description": "Human readable description",
      "mimeType": "application/json",
      "assetAddress": "TOKEN_MINT_ADDRESS",
      "timeout": 60000
    }
  ],
  "error": {
    "code": "INVALID_PAYMENT",
    "message": "Payment verification failed"
  }
}
```

### X-PAYMENT Header (Client â†’ Server)

Base64 encoded JSON:

```json
{
  "x402Version": "0.1.0",
  "scheme": "exact",
  "network": "solana-devnet",
  "payload": {
    "signature": "TRANSACTION_SIGNATURE",
    "from": "SENDER_PUBLIC_KEY",
    "to": "RECIPIENT_PUBLIC_KEY",
    "amount": "1000000",
    "mint": "TOKEN_MINT_ADDRESS",
    "timestamp": 1699564800000
  }
}
```

### X-PAYMENT-RESPONSE Header (Server â†’ Client)

Base64 encoded JSON:

```json
{
  "success": true,
  "transactionHash": "TRANSACTION_SIGNATURE",
  "network": "solana-devnet",
  "resource": {
    "id": "/api/resource",
    "type": "application/json",
    "expiresAt": 1699651200000
  }
}
```

## Error Codes

| Code | Description |
|------|-------------|
| `INVALID_PAYMENT` | Payment payload is malformed or invalid |
| `INSUFFICIENT_AMOUNT` | Payment amount is less than required |
| `EXPIRED_PAYMENT` | Payment timestamp exceeds timeout |
| `INVALID_SIGNATURE` | Transaction signature verification failed |
| `INVALID_NETWORK` | Network mismatch between client and server |
| `SETTLEMENT_FAILED` | Payment settlement on blockchain failed |
| `ALREADY_SETTLED` | Payment has already been settled |

## Advanced Usage

### Custom Payment Verification

```typescript
import { verifyPayment } from '@402pay/facilitator/middleware/x402';

const verification = await verifyPayment(paymentHeader, config, req);

if (!verification.isValid) {
  console.error(verification.invalidReason);
}
```

### Manual Payment Payload Creation

```typescript
import { createPaymentPayload } from '@402pay/facilitator/middleware/x402';

const paymentHeader = createPaymentPayload({
  signature: 'TRANSACTION_SIGNATURE',
  from: 'SENDER_PUBLIC_KEY',
  to: 'RECIPIENT_PUBLIC_KEY',
  amount: '1000000',
  network: 'solana-devnet',
});

// Use in X-PAYMENT header
fetch(url, {
  headers: {
    'X-PAYMENT': paymentHeader,
  },
});
```

### Batch Requests

```typescript
const client = new X402Client({ payer: keypair });

const requests = [
  client.paidRequest('http://localhost:3001/x402/paid-greeting'),
  client.paidRequest('http://localhost:3001/x402/paid-data'),
  client.paidRequest('http://localhost:3001/x402/paid-proxy/weather'),
];

const results = await Promise.all(requests);
console.log(`Made ${results.length} paid requests`);
```

### Check Price Before Paying

```typescript
// Get requirements first
const { priceInSOL } = await client.getPaymentRequirements(url);

// Show to user
console.log(`This will cost ${priceInSOL} SOL. Continue? (y/n)`);

// Then make paid request
if (userConfirmed) {
  const result = await client.paidRequest(url);
}
```

## Testing

### Running Example Endpoints

```bash
# Terminal 1: Start facilitator
cd packages/facilitator
npm run dev

# Terminal 2: Test endpoints
curl http://localhost:3001/x402
curl http://localhost:3001/x402/paid-greeting
```

### Integration Tests

```typescript
import { X402Client, generateTestWallet } from '@402pay/sdk';

describe('x402 Protocol', () => {
  it('should handle 402 payment flow', async () => {
    const { keypair } = generateTestWallet();
    const client = new X402Client({ payer: keypair });

    const result = await client.paidRequest('http://localhost:3001/x402/paid-greeting');

    expect(result.data).toBeDefined();
    expect(result.payment.signature).toBeDefined();
    expect(result.response.success).toBe(true);
  });
});
```

## Production Deployment

### Environment Variables

```bash
# Solana RPC URLs
SOLANA_MAINNET_RPC=https://api.mainnet-beta.solana.com
SOLANA_DEVNET_RPC=https://api.devnet.solana.com
SOLANA_TESTNET_RPC=https://api.testnet.solana.com

# Your wallet
DEMO_WALLET_ADDRESS=YourWalletAddress...

# Network
SOLANA_NETWORK=solana-devnet
```

### Security Best Practices

1. **Use mainnet for production**: Switch from `solana-devnet` to `solana`
2. **Implement rate limiting**: Prevent abuse of your endpoints
3. **Add request signing**: Prevent replay attacks
4. **Use HTTPS only**: Protect payment headers in transit
5. **Monitor transactions**: Track all payments and settlements
6. **Set appropriate timeouts**: Balance UX with security

### Scaling Considerations

- **Cache verification results**: Avoid re-verifying same transactions
- **Use connection pooling**: Reuse Solana RPC connections
- **Implement payment batching**: Settle multiple payments efficiently
- **Add Redis for deduplication**: Prevent double-spending
- **Use CDN for static content**: Reduce payment-gated load

## Use Cases

### 1. AI API Monetization

Charge per request for AI inference, image generation, or embeddings.

```typescript
app.post('/api/ai/generate',
  x402Middleware({ amount: '10000000', recipient: wallet, description: 'AI generation' }),
  async (req, res) => {
    const result = await openai.chat.completions.create({...});
    res.json(result);
  }
);
```

### 2. Premium Data APIs

Sell access to market data, analytics, or research.

```typescript
app.get('/api/premium/analytics',
  x402Middleware({ amount: '5000000', recipient: wallet, description: 'Analytics data' }),
  (req, res) => {
    res.json({ analytics: getAnalytics() });
  }
);
```

### 3. Agent-to-Agent Services

Enable autonomous agents to pay each other for services.

```typescript
// Agent A sells service
app.post('/agent/analyze',
  x402Middleware({ amount: '2000000', recipient: agentA, description: 'Data analysis' }),
  (req, res) => res.json({ analysis: analyzeData(req.body) })
);

// Agent B buys service
const agentB = new X402Client({ payer: agentBKeypair });
const result = await agentB.paidRequest('http://agent-a/agent/analyze', {
  method: 'POST',
  body: JSON.stringify({ data: myData }),
});
```

### 4. Metered Content Access

Charge per article, video, or download.

```typescript
app.get('/content/:id',
  x402Middleware({ amount: '1000000', recipient: wallet, description: 'Premium content' }),
  (req, res) => {
    const content = getContent(req.params.id);
    res.json(content);
  }
);
```

## FAQ

**Q: What's the difference between x402 and traditional payment APIs?**

A: x402 is a standard HTTP protocol using status code 402, making it natively understood by web infrastructure. Traditional payment APIs require custom integration.

**Q: Can I use SPL tokens instead of SOL?**

A: Yes, specify `assetAddress` with the token mint address. (Implementation coming soon)

**Q: How do I handle failed payments?**

A: The SDK automatically retries failed transactions. For persistent failures, check wallet balance with `checkBalance()`.

**Q: Is this production-ready?**

A: Yes, the protocol implementation is complete. For mainnet use, switch network to `'solana'` and use mainnet RPC URLs.

**Q: How are payments verified?**

A: The middleware fetches the transaction from Solana blockchain and verifies signature, amount, recipient, and confirmation status.

**Q: Can I refund payments?**

A: Payments are final on-chain. Implement your own refund logic by sending a new transaction back to the payer.

## Support

- **Documentation**: https://github.com/402pay/402pay
- **Examples**: `/packages/facilitator/src/routes/x402-examples.ts`
- **Issues**: https://github.com/402pay/402pay/issues

## License

MIT
