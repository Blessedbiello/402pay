// Prisma schema for 402pay Facilitator

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// API Keys for authentication
model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique // Hashed with bcrypt
  name      String
  userId    String
  environment String @default("live") // "test" or "live"
  permissions String[] // Array of permission strings
  lastUsed  DateTime?
  createdAt DateTime @default(now())
  expiresAt DateTime?
  revoked   Boolean  @default(false)
  metadata  Json?

  @@index([userId])
  @@index([key])
  @@index([userId, revoked]) // Fast active key lookup per user
  @@index([revoked, expiresAt]) // Cleanup expired/revoked keys
  @@map("api_keys")
}

// Agent wallets for AI agents
model Agent {
  id             String   @id @default(uuid())
  name           String
  publicKey      String   @unique
  owner          String
  spendingLimitDaily        Float?
  spendingLimitPerTransaction Float?
  allowedServices String[] // Whitelist of endpoints
  reputationScore           Int      @default(0)
  transactionCount          Int      @default(0)
  trustLevel     String   @default("new") // new, verified, trusted, premium
  createdAt      DateTime @default(now())
  metadata       Json?

  transactions   Transaction[]

  @@index([publicKey])
  @@index([owner])
  @@map("agents")
}

// Subscription plans
model SubscriptionPlan {
  id          String   @id @default(uuid())
  name        String
  description String?
  pricePerMonth Float
  currency    String   @default("USDC")
  features    String[]
  requestsPerMonth Int?
  requestsPerDay   Int?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  metadata    Json?

  subscriptions Subscription[]

  @@map("subscription_plans")
}

// Active subscriptions
model Subscription {
  id                String   @id @default(uuid())
  planId            String
  agentId           String
  walletAddress     String
  status            String   @default("active") // active, cancelled, expired, past_due
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  metadata          Json?

  plan   SubscriptionPlan @relation(fields: [planId], references: [id])
  usageRecords UsageRecord[]

  @@index([agentId])
  @@index([walletAddress])
  @@index([status])
  @@index([status, currentPeriodEnd]) // Expiry checks and renewal processing
  @@index([agentId, status]) // User's active subscriptions
  @@map("subscriptions")
}

// Usage records for metered billing
model UsageRecord {
  id             String   @id @default(uuid())
  subscriptionId String
  quantity       Int
  resource       String?
  timestamp      DateTime @default(now())
  metadata       Json?

  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([subscriptionId])
  @@index([timestamp])
  @@map("usage_records")
}

// Payment transactions
model Transaction {
  id            String   @id @default(uuid())
  signature     String   @unique // Solana transaction signature
  payer         String
  recipient     String
  amount        Float
  currency      String   @default("USDC")
  resource      String // API endpoint
  status        String   @default("confirmed") // pending, confirmed, failed
  nonce         String   @unique // For replay prevention
  subscriptionId String?
  agentId       String?
  timestamp     DateTime @default(now())
  metadata      Json?

  agent Agent? @relation(fields: [agentId], references: [id])

  @@index([payer])
  @@index([recipient])
  @@index([signature])
  @@index([nonce])
  @@index([timestamp])
  @@index([payer, timestamp]) // Dashboard transaction history
  @@index([recipient, status]) // Recipient's confirmed payments
  @@index([timestamp, status]) // Recent transactions by status
  @@index([agentId, timestamp]) // Agent payment history
  @@map("transactions")
}

// Analytics events
model AnalyticsEvent {
  id        String   @id @default(uuid())
  type      String   // payment, subscription, usage, error
  agentId   String?
  resource  String?
  amount    Float?
  currency  String?
  timestamp DateTime @default(now())
  metadata  Json?

  @@index([type])
  @@index([agentId])
  @@index([timestamp])
  @@index([type, timestamp]) // Analytics queries by type over time
  @@index([agentId, type, timestamp]) // Agent-specific analytics
  @@map("analytics_events")
}

// Nonce tracking for replay attack prevention
// Using Redis for this in production, but keeping DB option
model Nonce {
  id        String   @id @default(uuid())
  nonce     String   @unique
  usedAt    DateTime @default(now())
  expiresAt DateTime

  @@index([nonce])
  @@index([expiresAt])
  @@map("nonces")
}

// ============================================================================
// AgentForce Marketplace Models
// ============================================================================

// Services offered by agents in the marketplace
model AgentService {
  id          String   @id @default(uuid())
  agentId     String
  name        String
  description String
  category    String   // 'ai', 'data', 'development', 'automation', 'analytics'

  // Pricing configuration
  pricingModel String  // 'per-request', 'per-hour', 'fixed'
  priceAmount  Float
  priceCurrency String @default("USDC")

  // Capabilities and metadata
  capabilities String[]
  tags         String[]

  // Performance metrics
  averageResponseTime Int   @default(0) // milliseconds
  reliability         Float @default(100.0) // 0-100 score
  totalJobs           Int   @default(0)
  successfulJobs      Int   @default(0)
  totalEarnings       Float @default(0)

  // Status
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  metadata    Json?

  // Relations
  jobs JobRequest[]
  ratings Rating[]

  @@index([agentId])
  @@index([category])
  @@index([isActive])
  @@index([category, isActive]) // Marketplace category browsing
  @@index([isActive, totalJobs]) // Popular services (most jobs)
  @@index([isActive, totalEarnings]) // Leaderboard (top earners)
  @@index([isActive, priceAmount]) // Price filtering
  @@map("agent_services")
}

// Job requests between agents
model JobRequest {
  id              String   @id @default(uuid())
  clientAgentId   String   // Agent requesting the service
  serviceId       String
  providerAgentId String   // Agent providing the service

  // Job details
  status String @default("pending")
  // pending, accepted, in_progress, completed, approved, disputed, cancelled

  // Input/output stored as JSON
  input  Json
  output Json?

  // Payment details
  paymentAmount      Float
  paymentCurrency    String  @default("USDC")
  escrowAddress      String? // Solana account
  escrowStatus       String  @default("pending")
  // pending, escrowed, released, refunded, disputed
  escrowTransactionId String?

  // Timeline
  createdAt   DateTime  @default(now())
  acceptedAt  DateTime?
  completedAt DateTime?
  approvedAt  DateTime?
  deadline    DateTime
  updatedAt   DateTime  @updatedAt

  metadata Json?

  // Relations
  service AgentService @relation(fields: [serviceId], references: [id])
  rating  Rating?

  @@index([clientAgentId])
  @@index([providerAgentId])
  @@index([serviceId])
  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt]) // Job listing sorted by creation
  @@index([clientAgentId, status]) // Client's jobs by status
  @@index([providerAgentId, status]) // Provider's jobs by status
  @@index([status, deadline]) // Overdue job detection
  @@index([escrowStatus, status]) // Escrow management queries
  @@map("job_requests")
}

// Ratings and reviews for completed jobs
model Rating {
  id        String   @id @default(uuid())
  jobId     String   @unique
  serviceId String
  score     Int      // 1-5 stars
  feedback  String?
  createdAt DateTime @default(now())
  metadata  Json?

  job     JobRequest   @relation(fields: [jobId], references: [id])
  service AgentService @relation(fields: [serviceId], references: [id])

  @@index([serviceId])
  @@index([score])
  @@map("ratings")
}

// Achievement badges for agents
model Badge {
  id          String   @id @default(uuid())
  name        String
  description String
  icon        String   // Icon name or URL
  criteria    Json     // Requirements to earn badge
  createdAt   DateTime @default(now())

  agentBadges AgentBadge[]

  @@map("badges")
}

// Many-to-many relationship between agents and badges
model AgentBadge {
  id        String   @id @default(uuid())
  agentId   String
  badgeId   String
  earnedAt  DateTime @default(now())
  metadata  Json?

  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([agentId, badgeId])
  @@index([agentId])
  @@index([badgeId])
  @@map("agent_badges")
}
